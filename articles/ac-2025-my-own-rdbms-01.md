---
title: "ã¯ã˜ã‚ã« & Tupleã®SerDe ï¼ˆä¸€äººè‡ªä½œRDBMS Advent Calendar 2025 1æ—¥ç›®ï¼‰"
emoji: "ğŸ˜"
type: "tech"
topics: ["database", "db", "rdbms", "transaction"]
published: true
publication_name: "primenumber"
---

# ã¯ã˜ã‚ã« & Tupleã®SerDe ï¼ˆä¸€äººè‡ªä½œRDBMS Advent Calendar 2025 1æ—¥ç›®ï¼‰

ã“ã®è¨˜äº‹ã¯ã€Œ[ä¸€äººè‡ªä½œRDBMS Advent Calendar 2025](https://qiita.com/advent-calendar/2025/my-own-rdbms)ã€1æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

## ã¯ã˜ã‚ã«

ç§ã¯æ•°å¹´å‰ã‹ã‚‰è¶£å‘³ã§RDBMSã‚’å®Ÿè£…ã—ã¦éŠã‚“ã§ã„ã‚‹ä¸€ä»‹ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
ã¨ã„ã£ã¦ã‚‚ã€ã‚¢ã‚«ãƒ‡ãƒŸãƒƒã‚¯ãªãƒ¬ãƒ™ãƒ«ã§ã®é€ è©£ãŒç‰¹æ®µæ·±ã„ã‚ã‘ã§ã¯ãªãã€CMUã®[Intro to Database Systems](https://15445.courses.cs.cmu.edu/fall2025/schedule.html)ãªã©ã‚’å‚è€ƒã«è¦‹ã‚ˆã†è¦‹ã¾ã­ã§æ¥½ã—ã‚“ã§ã„ã‚‹ã€ã¨ã„ã£ãŸãƒ¬ãƒ™ãƒ«æ„Ÿã§ã™ã€‚

ä»Šå¹´ã‚‚ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å­£ç¯€ãŒã‚„ã£ã¦ããŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€ã€ŒLLMã®åŠ›ã‚’ä¸€å®šå€Ÿã‚Šã‚Œã°ã€ä¸€äººã‚¢ãƒ‰ã‚«ãƒ¬ã¨ã„ã†é…”ç‹‚ãªå–ã‚Šçµ„ã¿ã‚‚å®Œèµ°ã§ãã‚‹ã®ã§ã¯ï¼Ÿã€ã¨æ€ã„ãŸã¡ã€å§‹ã‚ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åŠåˆ†ãã‚‰ã„ã¾ã§ã¯æ—¢ã«å®Ÿè£…ã§ãã¦ãŠã‚Šä»Šå¹´ã¯è¡Œã‘ãã†ãªæ°—ãŒã—ã¦ã„ã¾ã™ã€‚ï¼‰

æœ¬ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã¯ã€Rustã‚’ä½¿ã£ã¦RDBMSã‚’ã‚¼ãƒ­ã‹ã‚‰æ§‹ç¯‰ã—ã¦ã„ãã¾ã™ã€‚
å˜ã«å‹•ãã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã ã‘ã§ãªãã€ã€ŒãªãœRDBMSã¯ãã®ã‚ˆã†ã«ä½œã‚‰ã‚Œã¦ã„ã‚‹ã®ã‹ã€ã¨ã„ã†æœ¬è³ªã®éƒ¨åˆ†ã‚’ã€å®Ÿè£…ã‚’é€šã˜ä½“æ„Ÿã§ãã‚‹ã¨ã“ã‚ã‚’ç›®æŒ‡ã—ã¦ã„ãã¾ã™ã€‚
èˆˆå‘³ã‚’æŒã£ã¦ã„ãŸã ã‘ãŸã‚‰ã€CMUã®è¬›ç¾©ã‚„ç§ã‚ˆã‚Šã‚‚è©³ã—ã„å…ˆäººã®è¨˜äº‹ãªã©ã‚‚è¿½ã£ã¦ã¿ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚

å…¨ã‚³ãƒ¼ãƒ‰ã¯[GitHub](https://github.com/gtnao/advent-calendar-2025-my-own-rdbms)ã«æ—¥ä»˜ã”ã¨ã«åŒºåˆ‡ã£ã¦ç½®ã„ã¦ã„ã¾ã™ã€‚
ãªãŠã€å…¨ã¦ã®è¨˜äº‹ã¨ã‚³ãƒ¼ãƒ‰ã¯ç§ã®ç›£ä¿®/ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é€šã—ã¦ã„ã¾ã™ãŒã€æ™‚é–“ã®éƒ½åˆä¸Šã€LLMã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸéƒ¨åˆ†ã‚‚å¤šåˆ†ã«å«ã¾ã‚Œã¦ã„ã¾ã™ã®ã§ã”äº†æ‰¿ãã ã•ã„ã€‚

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«

RDBMSã®æœ€ã‚‚åŸºæœ¬çš„ãªå˜ä½ã§ã‚ã‚‹è¡Œã€ã™ãªã‚ã¡**Tuple**ã¨ã€ãã®ãƒã‚¤ãƒŠãƒªè¡¨ç¾ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ãƒ†ãƒ¼ãƒ–ãƒ«ã®1è¡Œã‚’ãƒã‚¤ãƒˆåˆ—ã«å¤‰æ›ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿ã€èª­ã¿å‡ºã™ã ã‘ã§ã™ã€‚
ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°ã‚‚å‰Šé™¤ã‚‚ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ãªã„ã€ãŸã ã®è¿½è¨˜å‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å§‹ã‚ã¦ã„ãã¾ã™ã€‚

## ãªãœãƒã‚¤ãƒŠãƒªãªã®ã‹ï¼Ÿ

å¿µã®ãŸã‚ç¢ºèªã—ã¦ãŠãã¨ã€JSONã‚„CSVã§ã¯ãªããƒã‚¤ãƒŠãƒªã‚’æ¡ç”¨ã™ã‚‹ã®ã¯ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰ã§ã™ã€‚

1. **å®¹é‡**: ãƒã‚¤ãƒŠãƒªã¯ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã€‚ä¾‹ãˆã°64bitæ•´æ•°ã®`9223372036854775807`ã¯ãƒ†ã‚­ã‚¹ãƒˆã ã¨19ãƒã‚¤ãƒˆå¿…è¦ã ãŒã€ãƒã‚¤ãƒŠãƒªãªã‚‰å¸¸ã«8ãƒã‚¤ãƒˆã§æ¸ˆã‚€ã€‚ã¾ãŸã€CSVã‚„JSONã§ã¯`,`ã‚„`{`ã‚„`"`ãªã©ã®åŒºåˆ‡ã‚Šæ–‡å­—ã‚‚å†—é•·ã«ãªã‚‹
2. **ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ã‚¯ã‚»ã‚¹**: ãƒã‚¤ãƒŠãƒªãªã‚‰ç‰¹å®šã®å ´æ‰€ã«ç›´æ¥ã‚¸ãƒ£ãƒ³ãƒ—ã—ã‚„ã™ã„ã€‚ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã¯éƒ½åº¦ãƒ‘ãƒ¼ã‚¹ãŒå¿…è¦ã§ã€UTF-8ã®ã‚ˆã†ãªå¯å¤‰é•·ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã§ã¯Næ–‡å­—ç›®ã¸ã®ã‚¸ãƒ£ãƒ³ãƒ—ã‚‚ã§ããªã„

## Tupleã®ãƒã‚¤ãƒŠãƒªè¡¨ç¾

ä»Šå›ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã¯1ã¤ã«å›ºå®šã—ã€ã‚¹ã‚­ãƒ¼ãƒã‚‚`id`ï¼ˆINTï¼‰ã¨`name`ï¼ˆVARCHARï¼‰ã®2ã‚«ãƒ©ãƒ ã§å›ºå®šã¨ã—ã¾ã™ã€‚

```
users(id INT, name VARCHAR)
```

ã“ã‚Œã‚’ãƒã‚¤ãƒˆåˆ—ã«ã™ã‚‹ã¨ãã€ç´ æœ´ã«è€ƒãˆã‚‹ã¨ï¼š

```
+--------+------------+-----------+
| ID(4B) | NameLen(4B)| Name(å¯å¤‰) |
+--------+------------+-----------+
```

INTã¯4ãƒã‚¤ãƒˆå›ºå®šã€‚VARCHARã¯é•·ã•ã‚’å…ˆã«æ›¸ã„ã¦ã€ãã®å¾Œã«å®Ÿãƒ‡ãƒ¼ã‚¿ã€‚ã“ã®ã‚ˆã†ã«ã™ã‚Œã°ã€å‰ã‹ã‚‰é †ã«èª­ã¿å–ã£ã¦ã„ãã“ã¨ãŒã§ãã¾ã™ã€‚

## Null Bitmap

NULLã‚’ã©ã†è¡¨ç¾ã™ã‚‹ã‹ã€‚

NULLã‚’å˜ã«ã€Œ0ãƒã‚¤ãƒˆã€ã§è¡¨ç¾ã—ã¦ã—ã¾ã†ã¨ã€æ¬¡ã®ãƒã‚¤ãƒˆåˆ—ãŒãã®ã‚«ãƒ©ãƒ ã®å€¤ãªã®ã‹æ¬¡ã®ã‚«ãƒ©ãƒ ãªã®ã‹åŒºåˆ¥ãŒã¤ã‹ãªããªã‚Šã¾ã™ã€‚
ã‹ã¨è¨€ã£ã¦ãƒ•ãƒ©ã‚°ãƒã‚¤ãƒˆã‚’å„ã‚«ãƒ©ãƒ ã«ä»˜ã‘ã‚‹ã¨ã€NOT NULLã®ã‚«ãƒ©ãƒ ã§ã‚‚1ãƒã‚¤ãƒˆç„¡é§„ã«ãªã‚Šã¾ã™ã€‚

ãã“ã§**Null Bitmap**ã‚’ä½¿ã„ã¾ã™ã€‚
Tupleã®å…ˆé ­ã«ã€å„ã‚«ãƒ©ãƒ ãŒNULLã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ“ãƒƒãƒˆãƒãƒƒãƒ—ã‚’ç½®ãã¾ã™ã€‚

```
+-------------+--------+------------+-----------+
| Bitmap(1B)  | ID(4B) | NameLen(4B)| Name(å¯å¤‰) |
+-------------+--------+------------+-----------+
```

ãƒ“ãƒƒãƒˆãŒç«‹ã£ã¦ã„ã‚Œã°å€¤ã‚ã‚Šã€ç«‹ã£ã¦ã„ãªã‘ã‚Œã°NULLã€‚
NULLã®ã‚«ãƒ©ãƒ ã¯ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã‚’æ›¸ãè¾¼ã¾ãªã„ã®ã§ã€å®¹é‡ã‚‚ç¯€ç´„ã§ãã¾ã™ã€‚

ä¾‹ãˆã°2ã‚«ãƒ©ãƒ ã§`(NULL, "Alice")`ã®å ´åˆã€Bitmapã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

```
Bitmap (1 byte)
+---+---+---+---+---+---+---+---+
| 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 |  â† bit0=0: id is NULL
+---+---+---+---+---+---+---+---+     bit1=1: name has value
  7   6   5   4   3   2   1   0
```

8ã‚«ãƒ©ãƒ ã¾ã§ãªã‚‰1ãƒã‚¤ãƒˆã€16ã‚«ãƒ©ãƒ ã¾ã§ãªã‚‰2ãƒã‚¤ãƒˆã¨åŠ¹ç‡çš„ã§ã™ã€‚

## Serialize / Deserialize

å®Ÿè£…ã®æ ¸ã¨ãªã‚‹éƒ¨åˆ†ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
ï¼ˆå®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯`serialize_value`/`deserialize_value`ãªã©é–¢æ•°ã‚’åˆ†å‰²ã—ã¦ã„ã¾ã™ãŒã€ã“ã“ã§ã¯èª¬æ˜ã®ãŸã‚ä¸€ã¤ã®é–¢æ•°ã«ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚ï¼‰

### Serialize

```rust
fn serialize_tuple(values: &[Value], schema: &Schema) -> Vec<u8> {
    let mut buf = Vec::new();

    // Null Bitmap: å€¤ãŒã‚ã‚Œã°ãƒ“ãƒƒãƒˆã‚’ç«‹ã¦ã‚‹
    let bitmap_size = schema.columns.len().div_ceil(8);
    let mut bitmap = vec![0u8; bitmap_size];
    for (i, value) in values.iter().enumerate() {
        if !matches!(value, Value::Null) {
            bitmap[i / 8] |= 1 << (i % 8);
        }
    }
    buf.extend(&bitmap);

    for value in values {
        match value {
            Value::Null => {} // NULLã¯ä½•ã‚‚æ›¸ãè¾¼ã¾ãªã„
            Value::Int(v) => buf.extend(v.to_ne_bytes()),
            Value::Varchar(s) => {
                buf.extend((s.len() as u32).to_ne_bytes()); // é•·ã•ã‚’å…ˆã«æ›¸ã
                buf.extend(s.as_bytes());
            }
        }
    }
    buf
}
```

### Deserialize

```rust
fn deserialize_tuple(data: &[u8], schema: &Schema) -> Result<(Vec<Value>, usize)> {
    let bitmap_size = schema.columns.len().div_ceil(8);
    let bitmap = &data[0..bitmap_size];
    let mut offset = bitmap_size;
    let mut values = Vec::new();

    for (i, column) in schema.columns.iter().enumerate() {
        // ãƒ“ãƒƒãƒˆãŒç«‹ã£ã¦ã„ãªã‘ã‚Œã°NULL
        let is_null = bitmap[i / 8] & (1 << (i % 8)) == 0;
        if is_null {
            values.push(Value::Null);
            continue;
        }
        match column.data_type {
            DataType::Int => {
                let v = i32::from_ne_bytes(data[offset..offset + 4].try_into()?);
                values.push(Value::Int(v));
                offset += 4;
            }
            DataType::Varchar => {
                // å…ˆé ­4ãƒã‚¤ãƒˆãŒé•·ã•
                let len = u32::from_ne_bytes(data[offset..offset + 4].try_into()?) as usize;
                offset += 4;
                let s = String::from_utf8(data[offset..offset + len].to_vec())?;
                values.push(Value::Varchar(s));
                offset += len;
            }
        }
    }
    Ok((values, offset))
}
```

## æ°¸ç¶šåŒ–

ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãè¾¼ã¿ã§æ³¨æ„ã™ã¹ãç‚¹ãŒä¸€ã¤ã‚ã‚Šã¾ã™ã€‚

```rust
file.write_all(&data)?; // Serializeã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€
file.flush()?;  // ã“ã‚Œã ã‘ã§ã¯ä¸ååˆ†
```

`flush()`ã¯ãƒãƒƒãƒ•ã‚¡ã‚’ã‚«ãƒ¼ãƒãƒ«ç©ºé–“ã«æ¸¡ã™ã ã‘ã§ã€ãƒ‡ã‚£ã‚¹ã‚¯ã¸ã®æ›¸ãè¾¼ã¿ã‚’ä¿è¨¼ã—ã¾ã›ã‚“ã€‚
é›»æºãŒè½ã¡ãŸã‚‰æ¶ˆãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

```rust
file.write_all(&data)?;
file.sync_all()?;  // fsyncç›¸å½“ã€ãƒ‡ã‚£ã‚¹ã‚¯ã¾ã§æ›¸ãè¾¼ã‚€
```

`sync_all()`ï¼ˆPOSIXã®`fsync`ï¼‰ã‚’å‘¼ã¶ã“ã¨ã§ã€ä¸æ®ç™ºæ€§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®æ›¸ãè¾¼ã¿ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚
ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¯è½ã¡ã¾ã™ãŒã€Durabilityã®ãŸã‚ã«ã¯å¿…è¦ã§ã™ã€‚

å¾Œã®ç« ã§WALã‚’å®Ÿè£…ã™ã‚‹éš›ã«ã€ã“ã®è¾ºã‚Šã¯ã‚‚ã†å°‘ã—æ˜ã‚Šä¸‹ã’ã¾ã™ã€‚

## å‹•ä½œç¢ºèª

å®Ÿéš›ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚“ã å¾Œã«èª­ã¿è¾¼ã‚“ã§ã¿ã¾ã™ã€‚

```rust
insert(&[Value::Int(1), Value::Varchar("Alice".to_string())], &schema)?;
insert(&[Value::Int(2), Value::Null], &schema)?;
insert(&[Value::Null, Value::Varchar("Charlie".to_string())], &schema)?;

let tuples = scan(&schema)?;
for values in tuples {
    println!("{:?}", values);
}
```

å®Ÿè¡Œçµæœï¼ˆstdoutï¼‰:

```
Scanned 3 tuples:
  [Int(1), Varchar("Alice")]
  [Int(2), Null]
  [Null, Varchar("Charlie")]
```

NULLã‚’å«ã‚€Tupleã‚‚æ­£ã—ãèª­ã¿æ›¸ãã§ãã¦ã„ã¾ã™ã€‚

## ä»Šæ—¥ã®å®Ÿè£…ã®é™ç•Œ

æ­£ç›´ã€ã“ã®å®Ÿè£…ã¯æ¥µã‚ã¦åŸå§‹çš„ã§ã™ã€‚

- **å…¨ä»¶ã‚¹ã‚­ãƒ£ãƒ³**: å¯å¤‰é•·ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã®ã§Nç•ªç›®ã®Tupleã«ç›´æ¥ã‚¸ãƒ£ãƒ³ãƒ—ã§ããšã€ç‰¹å®šã®IDã‚’è¦‹ã¤ã‘ã‚‹ã«ã¯ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- **è¿½è¨˜ã®ã¿**: æ›´æ–°ãƒ»å‰Šé™¤ãŒã§ããªã„ã€‚ä¸€åº¦æ›¸ã„ãŸãƒ‡ãƒ¼ã‚¿ã¯å¤‰ãˆã‚‰ã‚Œãªã„

ã“ã‚Œã‚‰ã¯æ¬¡å›ä»¥é™ã§è§£æ±ºã—ã¦ã„ãã¾ã™ã€‚

## æ¬¡å›äºˆå‘Š

æ˜æ—¥ã¯**Page**ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã‚’å›ºå®šã‚µã‚¤ã‚ºã®ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆãƒšãƒ¼ã‚¸ï¼‰ã«æ•´ç†ã™ã‚‹ã“ã¨ã§ã€Tupleã®ç®¡ç†ãŒåŠ¹ç‡çš„ã«è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã€å¾Œã®Buffer Poolãªã©ã¸ã®å¸ƒçŸ³ã¨ãªã‚Šã¾ã™ã€‚
