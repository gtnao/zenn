---
title: "自作DBMSのためのトランザクション覚え書き（前編）"
emoji: "🐘"
type: "tech"
topics: ["database", "db", "rdbms", "transaction"]
published: false
publication_name: "primenumber"
---

# はじめに

本記事は、自作DBMSを趣味とする筆者が、トランザクション周りの実装を進めるにあたって自身の中で概念を咀嚼するために調査・体系化した内容を、せっかくなので公開記事にしたものです。
人類が生み出したソフトウェアの叡智の結晶の1つであるDBMS、その根幹に鎮座するトランザクション理論は、ユーザー視点での「あって当たり前」という感覚とは裏腹に、裏側の実現方法や理論を把握することは大変困難です。
従って、本記事に至っても、歴史的な経緯や厳密な定義などに筆者の理解不足が含まれている可能性が大いにあります。お手柔らかにご指摘ください。

# トランザクションとは

データベースにおけるトランザクションとは、一言で言うと「一連の読み書き操作をまとめたもの」と言えます。
古典的な耳にタコな例としては銀行の送金が挙げられ、一連の操作が「全て成功する」か「全て失敗する」かのどちらかであることを保証したい、という動機から生まれた概念です。
ただし、どのような操作をまとめるかはアプリケーション側の責務であり、DBMS側はそれがどういった意味を持つかには関与しません。
その代わり、抽象的ないくつかの特性を保証します。
ACID特性が広く知られていますが、これは非常に曖昧なので、「ACID特性を保証」とだけ言っても大した情報量がないです。
特にひどいのはConsistency （一貫性）で、「口座残高がマイナスにならない」などの具体的なビジネスロジックに依存する概念であり、アプリケーション側が保証すべき責務です。
DBMSの型や各制約が一貫性を支援することはありますが、一般化できないものであり、少なくともトランザクション理論を考える際にはノイズでしかないです。
かの『データ指向アプリケーションデザイン』でも、ACIDはコマーシャル用語と痛烈に批判されています。
残りのAtomicity、Isolation、Durabilityに関してはDB側の責務と言えますが、これらも定義が曖昧なので、もう少し解像度を上げていきます。
これらの性質はお互いに関係しあっている部分もありますが、適切に分解して考えると、少しはトランザクションの全容を理解しやすくなると個人的に思っています。

# AID

## Atomicity

Atomicityは、前述の「全て成功する」か「全て失敗する」かを保証する性質です。
実現方法としては、処理を完了できない場合（Abort/Rollback時）には、トランザクション開始以降の操作を覚えておき、それらを逆順で復元する処理を行えばいいでしょう。
一点注意しておきたいのは、Atomicity自体は単一のトランザクションでも成り立つ性質であり、後述のIsolationのような複数のトランザクション間の性質ではないという点です。

## Durability

Durabilityは、一度Commitが完了したトランザクションのデータが欠損しないことを保証する性質です。
とはいえ、隕石が落ちてきたらどうしようもないので、トランザクションレイヤーの話においては、不揮発性ストレージに保存が完了した時点でDurabilityを満たしたと言っても良いでしょう。
不揮発性ストレージに保存すればいいなら、Commitのたびに書き込みをしていれば満たせそうですが、現実的にはディスクアクセスはすこぶる遅いため、DBMSはできうる限り揮発性のメモリアクセスを駆使しようとします。
そのトレードオフとして、Durabilityを保証するためのアルゴリズムが求められます。
BufferPool、WAL、ARIESといった概念が登場しますが、今回はDurabilityの話はしません。
次のIsolationでお腹いっぱいだからです。

## Isolation

Isolationは、複数のトランザクションが同時に実行される状況において、お互いに影響を与えないことを保証する性質です。
複数のトランザクションが生存している状態では、結果的にAbortされるトランザクションの行った変更が、別のトランザクションに影響を与えてしまう、ということが考えられます。
少なくともそういった影響を与えない一番簡単な方法は、DBMS側で完全に1つずつ逐次実行するように制御することです。
トランザクションT1とT2がある場合に、T1→T2もしくはT2→T1と実行すればいいだけです。 しかしながら、あるトランザクションが完了するまで他のトランザクションは一切処理をされないわけなので、現実的にはパフォーマンス上、許容し難いことは自明でしょう。
そこで通常は、複数のトランザクションを並行に実行し、トランザクション内の各操作の実行順序は入り混じることになります。 本記事では、どういった順序であればIsolationを保証していると言えるか、という話を中心にしていきます。
