---
title: "B-Treeï¼ˆä¸€äººè‡ªä½œRDBMS Advent Calendar 2025 19æ—¥ç›®ï¼‰"
emoji: "ğŸ˜"
type: "tech"
topics: ["database", "rust", "db", "rdbms"]
published: false
publication_name: "primenumber"
---

ã“ã®è¨˜äº‹ã¯ã€Œ[ä¸€äººè‡ªä½œRDBMS Advent Calendar 2025](https://qiita.com/advent-calendar/2025/my-own-rdbms)ã€19æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æœ¬æ—¥ã®å®Ÿè£…ã¯[GitHub](https://github.com/gtnao/advent-calendar-2025-my-own-rdbms/tree/main/day19)ã«ã‚ã‚Šã¾ã™ã€‚æ˜¨æ—¥ã‹ã‚‰ã®å·®åˆ†ã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã¾ã™ã€‚

```bash
git diff --no-index day18 day19
```

## ä»Šæ—¥ã®ã‚´ãƒ¼ãƒ«

æ˜¨æ—¥Aggregate/GROUP BYã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ä»Šæ—¥ã‹ã‚‰ã¯**Index**ã®å®Ÿè£…ã«ç€æ‰‹ã—ã¾ã™ã€‚Indexã®å®Ÿè£…ã¯è¤‡é›‘ãªãŸã‚ã€è¤‡æ•°æ—¥ã«åˆ†ã‘ã¦é€²ã‚ã¾ã™ã€‚

ä»Šæ—¥ã¯Indexã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã‚ã‚‹**B-Tree**ã®åŸºç›¤éƒ¨åˆ†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ï¼š

- ãƒšãƒ¼ã‚¸æ§‹é€ ã®æ•´ç†ï¼ˆHeapPageã€LeafNodeã€InternalNodeï¼‰
- B-Treeã®æŒ¿å…¥ï¼ˆInsertï¼‰ã¨ç¯„å›²æ¤œç´¢ï¼ˆRange Scanï¼‰
- ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹å‹•ä½œç¢ºèª

## HeapPageã¸ã®åç§°å¤‰æ›´

ã“ã‚Œã¾ã§å˜ã«ã€ŒPageã€ã¨å‘¼ã‚“ã§ã„ãŸãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’ã€ä»Šå›ã‹ã‚‰`HeapPage`ã¨å‘¼ã³ã¾ã™ã€‚

```
ã“ã‚Œã¾ã§: Pageï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰

ä»Šå›ã‹ã‚‰: HeapPageï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
          LeafNodeï¼ˆB-Treeãƒªãƒ¼ãƒ•ç”¨ï¼‰
          InternalNodeï¼ˆB-Treeå†…éƒ¨ãƒãƒ¼ãƒ‰ç”¨ï¼‰
```

Heapï¼ˆãƒ’ãƒ¼ãƒ—ï¼‰ã¨ã¯ã€ã‚¿ãƒ—ãƒ«ã‚’é †åºãªãæ ¼ç´ã™ã‚‹æ–¹å¼ã®ã“ã¨ã§ã™ã€‚B-Treeãƒšãƒ¼ã‚¸ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚ã«ã“ã®åå‰ã‚’ä½¿ã„ã¾ã™ã€‚

## B-Treeã®æ§‹é€ 

B-Treeã¯ã€ãƒ‡ã‚£ã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã‚ˆãä½¿ã‚ã‚Œã‚‹å¹³è¡¡æœ¨ã§ã™ã€‚å„ãƒãƒ¼ãƒ‰ãŒãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã«åã¾ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ãƒ‡ã‚£ã‚¹ã‚¯I/Oã‚’æœ€å°åŒ–ã§ãã¾ã™ã€‚

```
                    [30]              â† InternalNodeï¼ˆãƒ«ãƒ¼ãƒˆï¼‰
                   /    \
            [10|20]      [40|50]      â† InternalNode
           /   |   \    /   |   \
         [5] [15] [25] [35] [45] [55] â† LeafNodeï¼ˆãƒªãƒ¼ãƒ•ï¼‰
          â†”   â†”   â†”   â†”   â†”   â†”
              ãƒªãƒ¼ãƒ•é–“ãƒªãƒ³ã‚¯
```

- **InternalNode**: ã‚­ãƒ¼ã¨å­ãƒšãƒ¼ã‚¸ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’æŒã¡ã€æ¤œç´¢ã®é“æ¡ˆå†…ã‚’ã™ã‚‹
- **LeafNode**: å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚­ãƒ¼ã¨RIDï¼‰ã‚’æ ¼ç´ã—ã€éš£æ¥ãƒªãƒ¼ãƒ•ã¸ã®ãƒªãƒ³ã‚¯ã‚’æŒã¤

## ãƒšãƒ¼ã‚¸ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

### LeafNode

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (16 bytes)                                           â”‚
â”‚   [0]      node_type = 0 (leaf)                            â”‚
â”‚   [1..3]   key_count                                        â”‚
â”‚   [3..5]   free_space_offset                               â”‚
â”‚   [5..9]   prev_leaf_page_id                               â”‚
â”‚   [9..13]  next_leaf_page_id                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot Array (grows â†’)     â”‚ Free Space â”‚ Entries (â† grows)  â”‚
â”‚ [off|len][off|len]...    â”‚            â”‚ [key|rid][key|rid] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

HeapPageã¨åŒæ§˜ã«ã€ã‚¹ãƒ­ãƒƒãƒˆé…åˆ—ã¯å‰æ–¹ã¸ã€ã‚¨ãƒ³ãƒˆãƒªã¯å¾Œæ–¹ã¸ä¼¸ã³ã¾ã™ã€‚ä¸¡è€…ãŒè¡çªã™ã‚‹ã¨ãƒšãƒ¼ã‚¸ãŒæº€æ¯ã«ãªã‚Šã¾ã™ã€‚

ãƒªãƒ¼ãƒ•ãƒãƒ¼ãƒ‰ã¯éš£æ¥ãƒªãƒ¼ãƒ•ã¸ã®ãƒã‚¤ãƒ³ã‚¿ï¼ˆprev/nextï¼‰ã‚’æŒã¤ãŸã‚ã€ç¯„å›²æ¤œç´¢æ™‚ã«ãƒªãƒ¼ãƒ•é–“ã‚’åŠ¹ç‡çš„ã«ç§»å‹•ã§ãã¾ã™ã€‚

### InternalNode

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (16 bytes)                                           â”‚
â”‚   [0]      node_type = 1 (internal)                        â”‚
â”‚   [1..3]   key_count                                        â”‚
â”‚   [3..5]   free_space_offset                               â”‚
â”‚   [5..9]   rightmost_child                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Slot Array (grows â†’)     â”‚ Free Space â”‚ Entries (â† grows)  â”‚
â”‚ [off|len][off|len]...    â”‚            â”‚ [key|child]...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å†…éƒ¨ãƒãƒ¼ãƒ‰ã¯ã‚­ãƒ¼ã¨å­ãƒšãƒ¼ã‚¸IDã‚’æŒã¡ã¾ã™ã€‚ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¾“ã„ã¾ã™ã€‚

```
ã‚­ãƒ¼é…åˆ—: [K0, K1, K2, ...]
å­é…åˆ—:   [C0, C1, C2, ..., rightmost]

æ¤œç´¢ã‚­ãƒ¼ k ã«å¯¾ã—ã¦:
  k < K0        â†’ C0 ã¸
  K0 <= k < K1  â†’ C1 ã¸
  K1 <= k < K2  â†’ C2 ã¸
  ...
  k >= æœ€å¾Œã®ã‚­ãƒ¼ â†’ rightmost ã¸
```

## Insertå‡¦ç†

### åŸºæœ¬ãƒ•ãƒ­ãƒ¼

```
1. ãƒ«ãƒ¼ãƒˆã‹ã‚‰ãƒªãƒ¼ãƒ•ã‚’æ¢ã™ï¼ˆfind_leafï¼‰
2. ãƒªãƒ¼ãƒ•ã«ã‚¨ãƒ³ãƒˆãƒªã‚’æŒ¿å…¥
3. ãƒªãƒ¼ãƒ•ãŒæº€æ¯ãªã‚‰åˆ†å‰²ï¼ˆsplitï¼‰
4. åˆ†å‰²ã—ãŸã‚‰è¦ªã«æ–°ã—ã„ã‚­ãƒ¼ã‚’æŒ¿å…¥
5. è¦ªã‚‚æº€æ¯ãªã‚‰å†å¸°çš„ã«åˆ†å‰²
6. ãƒ«ãƒ¼ãƒˆãŒåˆ†å‰²ã—ãŸã‚‰æ–°ã—ã„ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆ
```

### ãƒªãƒ¼ãƒ•ã®åˆ†å‰²

ãƒªãƒ¼ãƒ•ãŒæº€æ¯ã®ã¨ãã€ã‚¨ãƒ³ãƒˆãƒªã‚’åŠåˆ†ã«åˆ†ã‘ã¦æ–°ã—ã„ãƒªãƒ¼ãƒ•ã‚’ä½œæˆã—ã¾ã™ã€‚

```
åˆ†å‰²å‰:
[10|20|30|40|50] (æº€æ¯)

åˆ†å‰²å¾Œ:
[10|20]  â†’  [30|40|50]
   â†‘           â†‘
 å…ƒãƒªãƒ¼ãƒ•    æ–°ãƒªãƒ¼ãƒ•

split_key = 30 ã‚’è¦ªã«æŒ¿å…¥
```

åˆ†å‰²å¾Œã¯ãƒªãƒ¼ãƒ•é–“ã®ãƒªãƒ³ã‚¯ï¼ˆprev/nextï¼‰ã‚’æ­£ã—ãæ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### å†…éƒ¨ãƒãƒ¼ãƒ‰ã®åˆ†å‰²

å†…éƒ¨ãƒãƒ¼ãƒ‰ãŒæº€æ¯ã®ã¨ãã€ä¸­å¤®ã®ã‚­ãƒ¼ã‚’è¦ªã«ã€ŒæŠ¼ã—ä¸Šã’ã€ã¾ã™ã€‚ãƒªãƒ¼ãƒ•ã¨ç•°ãªã‚Šã€ä¸­å¤®ã‚­ãƒ¼è‡ªä½“ã¯å…ƒã®ãƒãƒ¼ãƒ‰ã«æ®‹ã‚Šã¾ã›ã‚“ã€‚

```
åˆ†å‰²å‰:
[10|20|30|40|50] (æº€æ¯)

åˆ†å‰²å¾Œ:
[10|20]  â†’è¦ªã«30ã‚’æŒ¿å…¥â†’  [40|50]
```

## Range Scanå‡¦ç†

ç¯„å›²æ¤œç´¢ã¯ä»¥ä¸‹ã®ãƒ•ãƒ­ãƒ¼ã§è¡Œã„ã¾ã™ã€‚

```
1. é–‹å§‹ã‚­ãƒ¼ã«å¯¾å¿œã™ã‚‹ãƒªãƒ¼ãƒ•ã‚’æ¢ã™
2. é‡è¤‡ã‚­ãƒ¼å¯¾å¿œ: å‰æ–¹ã®ãƒªãƒ¼ãƒ•ã«åŒã˜ã‚­ãƒ¼ãŒã‚ã‚Œã°é¡ã‚‹
3. ãƒªãƒ¼ãƒ•ãƒã‚§ãƒ¼ãƒ³ã‚’è¾¿ã‚ŠãªãŒã‚‰ã‚¨ãƒ³ãƒˆãƒªã‚’åé›†
4. çµ‚äº†ã‚­ãƒ¼ã«é”ã—ãŸã‚‰çµ‚äº†
```

ãƒªãƒ¼ãƒ•é–“ãƒªãƒ³ã‚¯ãŒã‚ã‚‹ãŸã‚ã€å†…éƒ¨ãƒãƒ¼ãƒ‰ã‚’çµŒç”±ã›ãšã«ãƒªãƒ¼ãƒ•ã‚’é †ã«è¾¿ã‚Œã¾ã™ã€‚

## é‡è¤‡ã‚­ãƒ¼ã®æ‰±ã„

åŒã˜ã‚­ãƒ¼ã‚’æŒã¤è¤‡æ•°ã®ã‚¨ãƒ³ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ã‚¨ãƒ³ãƒˆãƒªã‚’`(key, rid)`ã®ãƒšã‚¢ã§ä¸€æ„ã«ã‚½ãƒ¼ãƒˆã—ã¾ã™ã€‚

```rust
// ã‚­ãƒ¼ãŒåŒã˜ãªã‚‰RIDã§æ¯”è¼ƒ
let cmp = match mid_key.cmp(key) {
    Ordering::Equal => mid_rid.cmp(rid),
    other => other,
};
```

ã“ã‚Œã«ã‚ˆã‚Šã€é‡è¤‡ã‚­ãƒ¼ãŒã‚ã£ã¦ã‚‚æŒ¿å…¥ä½ç½®ãŒä¸€æ„ã«æ±ºã¾ã‚Šã¾ã™ã€‚

## å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹

### BufferPoolManagerã®ãƒ­ãƒƒã‚¯

åŒã˜ãƒ­ãƒƒã‚¯ã‚’å†å–å¾—ã™ã‚‹ã¨ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚

```rust
// NG: ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯
let mut bpm = self.bpm.lock().unwrap();
// ... å‡¦ç† ...
let mut bpm = self.bpm.lock().unwrap();  // åŒã˜ãƒ­ãƒƒã‚¯ã‚’å†å–å¾—

// OK: ã‚¹ã‚³ãƒ¼ãƒ—ã§è§£æ”¾ã—ã¦ã‹ã‚‰å†å–å¾—
let result = {
    let mut bpm = self.bpm.lock().unwrap();
    // ... å‡¦ç† ...
    result
};  // bpm ã¯ã“ã“ã§è§£æ”¾
let mut bpm = self.bpm.lock().unwrap();  // OK
```

### unpin_pageã®å‘¼ã³å¿˜ã‚Œ

`fetch_page`ã—ãŸã‚‰å¿…ãš`unpin_page`ã‚’å‘¼ã³ã¾ã™ã€‚å¿˜ã‚Œã‚‹ã¨ãƒãƒƒãƒ•ã‚¡ãƒ—ãƒ¼ãƒ«ãŒæ¯æ¸‡ã—ã¾ã™ã€‚

```rust
let page = bpm.fetch_page(id)?;
// ... ä½¿ç”¨ ...
bpm.unpin_page(id, dirty)?;  // å¿…é ˆ
```

### åˆ†å‰²å¾Œã®ãƒªãƒ³ã‚¯è¨­å®š

`LeafNode::split`ã¯prev/nextã‚’ä»®ã®å€¤ã§åˆæœŸåŒ–ã—ã¾ã™ã€‚å‘¼ã³å‡ºã—å…ƒã§æ­£ã—ãè¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```rust
LeafNode::set_next_leaf(&mut src, Some(new_page_id));
LeafNode::set_prev_leaf(&mut dst, Some(src_page_id));
```

## ãƒ†ã‚¹ãƒˆ

B-Treeã¯è¤‡é›‘ãªãŸã‚ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦å‹•ä½œç¢ºèªã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€Indexã®å®Ÿè£…ã¯è¤‡æ•°æ—¥ã«ã¾ãŸãŒã‚‹ãŸã‚ã€é€”ä¸­æ®µéšã§ã®ãƒ†ã‚¹ãƒˆãŒé‡è¦ã§ã™ã€‚

```rust
#[test]
fn test_btree_insert_many_causes_split() {
    let (mut btree, _dir) = setup_btree();

    // 100ä»¶æŒ¿å…¥ã—ã¦åˆ†å‰²ã‚’ç™ºç”Ÿã•ã›ã‚‹
    for i in 0..100 {
        let key = IndexKey::single(Value::Int(i));
        let rid = Rid { page_id: i as u32, slot_id: 0 };
        btree.insert(&key, rid).unwrap();
    }

    // å…¨ä»¶æ¤œç´¢ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª
    for i in 0..100 {
        let key = IndexKey::single(Value::Int(i));
        assert_eq!(btree.search(&key).unwrap(), Some(...));
    }
}
```

ãƒ†ã‚¹ãƒˆã§ã¯ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ï¼š

- ç©ºã®ãƒ„ãƒªãƒ¼ã¸ã®æŒ¿å…¥ãƒ»æ¤œç´¢
- åˆ†å‰²ã‚’ä¼´ã†å¤§é‡æŒ¿å…¥
- é€†é †æŒ¿å…¥ï¼ˆåˆ†å‰²ã®åã‚Šã‚’ãƒ†ã‚¹ãƒˆï¼‰
- é‡è¤‡ã‚­ãƒ¼ã®æŒ¿å…¥ã¨æ¤œç´¢
- ç¯„å›²æ¤œç´¢ã®å¢ƒç•Œæ¡ä»¶
- NULLã‚„Varcharãªã©ç•°ãªã‚‹å‹ã®ã‚­ãƒ¼

## æ¬¡å›äºˆå‘Š

ä»Šæ—¥ã§B-Treeã®åŸºç›¤éƒ¨åˆ†ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

æ¬¡å›ã¯ã“ã®B-Treeã‚’ä½¿ã£ã¦ã€å®Ÿéš›ã«**CREATE INDEX**ã‚„**Index Scan**ã‚’å®Ÿè£…ã—ã€SQLã‚¯ã‚¨ãƒªã§Indexã‚’æ´»ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
